name: E2E Benchmark

on:
  # PR Ï≤¥ÌÅ¨
  pull_request:
    branches:
      - develop
      - master
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      # SDK ÌïµÏã¨ ÏΩîÎìú Î≥ÄÍ≤Ω ÏãúÏóêÎßå Ïã§Ìñâ
      - 'Runtime/**'
      - 'Editor/**'
      - 'WebGLTemplates/**'
      - 'package.json'
      # ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏûêÏ≤¥ Î≥ÄÍ≤Ω ÏãúÏóêÎèÑ Ïã§Ìñâ
      - '.github/workflows/e2e-benchmark.yml'

  # ÏàòÎèô Ìä∏Î¶¨Í±∞
  workflow_dispatch:
    inputs:
      unity_version:
        description: 'Unity version to use'
        required: false
        default: '2022.3.16f1'

  # Ï†ïÍ∏∞ Ïã§Ìñâ (Ï£º 1Ìöå ÏùºÏöîÏùº ÏûêÏ†ï)
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    # Draft PRÏùÄ Ïä§ÌÇµ (Î¶¨ÏÜåÏä§ Ï†àÏïΩ)
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Git ÏÑ§Ï†ï (HTTPS Ïù∏Ï¶ùÏö©)
      - name: Configure git for HTTPS
        run: |
          git config --global url."https://oauth2:${{ secrets.GITHUB_TOKEN }}@github.toss.bz/".insteadOf "https://github.toss.bz/"

      # Unity ÏÑ§Ïπò
      - name: Cache Unity installation
        id: cache-unity
        uses: actions/cache@v3
        with:
          path: /Applications/Unity
          key: unity-${{ inputs.unity_version || '2022.3.16f1' }}-macos

      - name: Install Unity
        if: steps.cache-unity.outputs.cache-hit != 'true'
        uses: game-ci/unity-builder@v4
        with:
          unityVersion: ${{ inputs.unity_version || '2022.3.16f1' }}
          buildMethod: ''  # ÏÑ§ÏπòÎßå

      # Unity ÎùºÏù¥ÏÑ†Ïä§ ÌôúÏÑ±Ìôî
      - name: Activate Unity license
        uses: game-ci/unity-activate@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      # Node.js ÏÑ§Ïπò
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Python ÏÑ§Ïπò (ÏÑúÎ≤ÑÏö©)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Chrome ÏÑ§Ïπò ÌôïÏù∏
      - name: Verify Chrome installation
        run: |
          if [ -f "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" ]; then
            echo "‚úÖ Chrome installed"
            "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" --version
          else
            echo "‚ùå Chrome not found, installing..."
            brew install --cask google-chrome
          fi

      # E2E Î≤§ÏπòÎßàÌÅ¨ Ïã§Ìñâ
      - name: Run E2E benchmark
        id: benchmark
        env:
          CI: true
        run: |
          cd Tests~/E2E
          chmod +x benchmark.sh
          ./benchmark.sh 2>&1 | tee benchmark.log
        continue-on-error: true

      # Í≤∞Í≥º ÌååÏã±
      - name: Parse benchmark results
        id: parse_results
        run: |
          cd Tests~/E2E

          # JSON Í≤∞Í≥º Ï∂îÏ∂ú
          if grep -q "avgFPS" benchmark.log; then
            echo "results_found=true" >> $GITHUB_OUTPUT

            # ÏÑ±Îä• Î©îÌä∏Î¶≠ Ï∂îÏ∂ú (macOSÎäî grep -PÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú sed ÏÇ¨Ïö©)
            AVG_FPS=$(grep -o '"avgFPS":[[:space:]]*[0-9.]*' benchmark.log | head -1 | sed 's/.*:[[:space:]]*//')
            MIN_FPS=$(grep -o '"minFPS":[[:space:]]*[0-9.]*' benchmark.log | head -1 | sed 's/.*:[[:space:]]*//')
            MEMORY=$(grep -o '"memoryUsageMB":[[:space:]]*[0-9.]*' benchmark.log | head -1 | sed 's/.*:[[:space:]]*//')

            echo "avg_fps=$AVG_FPS" >> $GITHUB_OUTPUT
            echo "min_fps=$MIN_FPS" >> $GITHUB_OUTPUT
            echo "memory=$MEMORY" >> $GITHUB_OUTPUT

            # ÏÑ±Îä• Í∏∞Ï§Ä Ï≤¥ÌÅ¨ (ÌèâÍ∑† FPS > 20, ÏµúÏÜå FPS > 10, Î©îÎ™®Î¶¨ < 1000MB)
            if [ -n "$AVG_FPS" ] && [ -n "$MIN_FPS" ] && [ -n "$MEMORY" ]; then
              if (( $(echo "$AVG_FPS > 20" | bc -l) )) && \
                 (( $(echo "$MIN_FPS > 10" | bc -l) )) && \
                 (( $(echo "$MEMORY < 1000" | bc -l) )); then
                echo "performance_pass=true" >> $GITHUB_OUTPUT
              else
                echo "performance_pass=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "performance_pass=false" >> $GITHUB_OUTPUT
            fi

            # ÏöîÏïΩ ÏÉùÏÑ±
            grep -A 20 "BENCHMARK RESULTS" benchmark.log > summary.txt || true
          else
            echo "results_found=false" >> $GITHUB_OUTPUT
            echo "performance_pass=false" >> $GITHUB_OUTPUT
          fi

      # PR ÏΩîÎ©òÌä∏ ÏûëÏÑ± (PR Ïù¥Î≤§Ìä∏Ïùº ÎïåÎßå)
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const resultsFound = '${{ steps.parse_results.outputs.results_found }}' === 'true';
            const performancePass = '${{ steps.parse_results.outputs.performance_pass }}' === 'true';

            let comment = '## üéÆ E2E Benchmark Results\n\n';

            if (resultsFound) {
              const avgFPS = '${{ steps.parse_results.outputs.avg_fps }}';
              const minFPS = '${{ steps.parse_results.outputs.min_fps }}';
              const memory = '${{ steps.parse_results.outputs.memory }}';

              comment += '### Performance Metrics\n\n';
              comment += `| Metric | Value | Status |\n`;
              comment += `|--------|-------|--------|\n`;
              comment += `| Avg FPS | ${avgFPS} | ${parseFloat(avgFPS) > 20 ? '‚úÖ' : '‚ùå'} |\n`;
              comment += `| Min FPS | ${minFPS} | ${parseFloat(minFPS) > 10 ? '‚úÖ' : '‚ùå'} |\n`;
              comment += `| Memory | ${memory} MB | ${parseFloat(memory) < 1000 ? '‚úÖ' : '‚ùå'} |\n\n`;

              comment += '### Performance Criteria\n';
              comment += '- Avg FPS > 20\n';
              comment += '- Min FPS > 10\n';
              comment += '- Memory < 1000 MB\n\n';

              if (performancePass) {
                comment += '‚úÖ **All performance checks passed!**\n';
              } else {
                comment += '‚ùå **Performance checks failed. Please optimize before merging.**\n';
              }
            } else {
              comment += '‚ùå **Benchmark failed to run. Please check the logs.**\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # Í≤∞Í≥º ÏóÖÎ°úÎìú
      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.event_name }}-${{ github.run_number }}
          path: |
            Tests~/E2E/benchmark.log
            Tests~/E2E/summary.txt
            Tests~/E2E/build.log
          retention-days: 30

      # Ïã§Ìå® Ïãú Î°úÍ∑∏ Ï∂úÎ†•
      - name: Display failure logs
        if: failure()
        run: |
          echo "=== Build Log (last 100 lines) ==="
          tail -100 Tests~/E2E/build.log || echo "No build log found"

          echo ""
          echo "=== Benchmark Log ==="
          cat Tests~/E2E/benchmark.log || echo "No benchmark log found"

      # ÏÑ±Îä• Í∏∞Ï§Ä ÎØ∏Îã¨ Ïãú Ïã§Ìå® (PR Ïù¥Î≤§Ìä∏Ïùº ÎïåÎßå)
      - name: Check performance criteria
        if: github.event_name == 'pull_request' && steps.parse_results.outputs.performance_pass != 'true'
        run: |
          echo "‚ùå Performance criteria not met!"
          echo "   - Avg FPS must be > 20"
          echo "   - Min FPS must be > 10"
          echo "   - Memory must be < 1000 MB"
          exit 1

      # Unity ÎùºÏù¥ÏÑ†Ïä§ Î∞òÌôò
      - name: Return Unity license
        if: always()
        uses: game-ci/unity-return-license@v4

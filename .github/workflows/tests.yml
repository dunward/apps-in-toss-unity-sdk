name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      clean_library:
        description: 'Clean Unity Library cache (for cache corruption issues)'
        type: boolean
        default: false
  # update.ymlì—ì„œ í˜¸ì¶œë  ë•Œ ì‚¬ìš© (GITHUB_TOKEN ì œí•œ ìš°íšŒ)
  workflow_call:
    inputs:
      clean_library:
        description: 'Clean Unity Library cache'
        type: boolean
        default: false
      ref:
        description: 'Git ref to checkout (branch name)'
        type: string
        required: false

jobs:
  # =====================================================
  # Pending Status ë³´ê³  (í…ŒìŠ¤íŠ¸ ì‹œìž‘ ì‹œ)
  # =====================================================
  report-pending:
    name: Report Pending Status
    runs-on: ubuntu-latest
    if: inputs.ref != ''

    steps:
      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ inputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Pending Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="pending" \
            -f target_url="$TARGET_URL" \
            -f description="E2E tests running..." \
            -f context="E2E Tests (via SDK Update)"

          echo "Reported pending status for commit $SHA"

  # =====================================================
  # SDK Generator Unit Tests
  # =====================================================
  sdk-generator-tests:
    name: SDK Generator Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Mono (for C# compilation tests)
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-mcs
          mcs --version

      - name: Install Dependencies
        working-directory: sdk-runtime-generator~
        run: pnpm install

      - name: Run Unit Tests (Tier 1 - C# compilation)
        working-directory: sdk-runtime-generator~
        run: pnpm run test:tier1

      - name: Run Unit Tests (Tier 2 - C#/jslib invariants)
        working-directory: sdk-runtime-generator~
        run: pnpm run test:tier2

  # =====================================================
  # E2E Tests - macOS (ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
  # =====================================================
  e2e-test-macos:
    name: E2E (macOS, Unity ${{ matrix.unity-version }})
    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    # NOTE: reusable workflow í˜¸ì¶œ ì‹œ concurrencyëŠ” unity-build.yml ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
    # caller jobì—ì„œ concurrency ì‚¬ìš© ì‹œ ì˜ˆìƒì¹˜ ëª»í•œ ì·¨ì†Œ ë°œìƒ

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ inputs.ref || '' }}
      os: macos
      unity-version: ${{ matrix.unity-version }}
      run-build: true
      run-e2e-test: true
      run-benchmark: true
      clean-library: ${{ inputs.clean_library || false }}

  # =====================================================
  # E2E Tests - Windows (í…ŒìŠ¤íŠ¸ 1-5ë§Œ ì‹¤í–‰)
  # =====================================================
  e2e-test-windows:
    name: E2E 1-5 (Windows, Unity ${{ matrix.unity-version }})
    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    # NOTE: reusable workflow í˜¸ì¶œ ì‹œ concurrencyëŠ” unity-build.yml ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
    # caller jobì—ì„œ concurrency ì‚¬ìš© ì‹œ ì˜ˆìƒì¹˜ ëª»í•œ ì·¨ì†Œ ë°œìƒ

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ inputs.ref || '' }}
      os: windows
      unity-version: ${{ matrix.unity-version }}
      run-build: true
      run-e2e-test: true
      run-benchmark: false
      clean-library: ${{ inputs.clean_library || false }}

  # =====================================================
  # Test Report Summary
  # =====================================================
  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [sdk-generator-tests, e2e-test-macos, e2e-test-windows]
    if: always()

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Generate Benchmark Report
        run: node .github/scripts/generate-benchmark-report.js

      - name: Write Job Summary
        run: cat benchmark-report.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('benchmark-report.md', 'utf8');

            // ê¸°ì¡´ ë²¤ì¹˜ë§ˆí¬ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## ðŸ“Š Benchmark Results')
            );

            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
              console.log('Updated existing benchmark comment');
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
              console.log('Created new benchmark comment');
            }

      - name: Upload Benchmark Report
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-report
          path: benchmark-report.md
          if-no-files-found: warn
          retention-days: 30

  # =====================================================
  # Commit Status ë³´ê³  (workflow_callë¡œ í˜¸ì¶œëœ ê²½ìš°)
  # =====================================================
  report-status:
    name: Report Status to PR
    runs-on: ubuntu-latest
    needs: [sdk-generator-tests, e2e-test-macos, e2e-test-windows]
    if: always() && inputs.ref != ''

    steps:
      - name: Determine Status
        id: status
        run: |
          SDK_RESULT="${{ needs.sdk-generator-tests.result }}"
          MACOS_RESULT="${{ needs.e2e-test-macos.result }}"
          WINDOWS_RESULT="${{ needs.e2e-test-windows.result }}"

          if [ "$SDK_RESULT" = "success" ] && [ "$MACOS_RESULT" = "success" ] && [ "$WINDOWS_RESULT" = "success" ]; then
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=All tests passed (SDK + E2E macOS:1-9, Windows:1-5)" >> $GITHUB_OUTPUT
          elif [ "$SDK_RESULT" = "cancelled" ] || [ "$MACOS_RESULT" = "cancelled" ] || [ "$WINDOWS_RESULT" = "cancelled" ]; then
            echo "state=error" >> $GITHUB_OUTPUT
            echo "description=Tests cancelled" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=Tests failed (SDK: $SDK_RESULT, macOS: $MACOS_RESULT, Windows: $WINDOWS_RESULT)" >> $GITHUB_OUTPUT
          fi

      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ inputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Commit Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          STATE="${{ steps.status.outputs.state }}"
          DESCRIPTION="${{ steps.status.outputs.description }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="$STATE" \
            -f target_url="$TARGET_URL" \
            -f description="$DESCRIPTION" \
            -f context="E2E Tests (via SDK Update)"

          echo "Reported status: $STATE for commit $SHA"
